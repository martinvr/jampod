var Transport = require('../lib/transport');
var Uhura = require('uhura');
var assert = require('assert');
var config = require('../lib/config');
var http = require('http');
var nf = require('../lib/main');
var tiers = require('../lib/tiers');

function verifyDataIntegrity(data) {
  assert('tiers' in data);
  assert('http' in data.tiers);
  assert('mean' in data.tiers.http);
  assert.equal(typeof(data.tiers.http.mean), 'number');
}

// Stub out start and initialize
var oldStart = tiers.prototype.start;
tiers.prototype.start = function() {};
var test = tiers.init();
tiers.prototype.start = oldStart;

// Add some data
test.sample('http', { ms: Date.now() });
verifyDataIntegrity(test.stats.toJSON());

// Do some cheating to speed up the test
config.tiersInterval = 500;

var expressServer;

// Black hole
var uhuraServer = Uhura.createServer(function(c) {
  c.on('createSession', function() {
    c.send('newSession', null, { sessionId: 'foo', appHash: 'bar' });
  });

  c.on('update', function(data) {
    if (!data.tiers || !data.tiers.http) return;
    nf.stop();
    c.disconnect();
    expressServer.close(function() {
      uhuraServer.close(function() { verifyDataIntegrity(data) });
    });
  });
}).listen(0, '127.0.0.1', function() {
  // Start profiling
  nf.profile('foo', 'bar', {
    host: this.address().address,
    port: this.address().port,
    quiet: true,
  });

  // Start an express server and make a request to it
  var app = require('express')();
  app.get('/', function(req, res) { res.end('bar'); });

  // Wrap in http server so it can be closed properly
  expressServer = http.createServer(app);
  expressServer.listen(0, '127.0.0.1', function() {
    http.get({
      host: this.address().address,
      port: this.address().port,
      path: '/people',
    });
  });
});
