process.env.SL_ENV = process.env.SL_ENV || 'dev';

var Uhura = require('uhura');
var agent = require('../');
var assert = require('assert');

var collector = Uhura.createServer(function(client) {
  client.on('createSession', function(data) {
    assert.equal(data.appName, 'some app');
    assert.equal(data.hostname, 'some host');
    assert.equal(/\d\.\d\.\d/.test(data.agentVersion), true);
    assert.equal(data.key, 'some key');
    assert.equal(typeof(data.pid), 'number');
    agent.stop();
    client.disconnect();
    collector.close();
  });
}).listen();

collector.on('listening', function() {
  agent.profile('some key',
                ['some app', 'some host'],
                { port: collector.address().port, quiet: true });
});
